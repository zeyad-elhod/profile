<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cars AI Playground</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    :root {
      --bg-light: #f8fafc;
      --bg-dark: #0d1117;
      --surface-light: #ffffff;
      --surface-dark: #111827;
      --accent: #22d3ee;
      --accent-hover: #0ea5e9;
      --text-light: #0f172a;
      --text-dark: #e5e7eb;
      --muted-light: #475569;
      --muted-dark: #9ca3af;
      --border-light: #e2e8f0;
      --border-dark: #1f2937;
    }

    html[data-theme="light"] {
      --bg: var(--bg-light);
      --surface: var(--surface-light);
      --text: var(--text-light);
      --muted: var(--muted-light);
      --border: var(--border-light);
    }

    html[data-theme="dark"] {
      --bg: var(--bg-dark);
      --surface: var(--surface-dark);
      --text: var(--text-dark);
      --muted: var(--muted-dark);
      --border: var(--border-dark);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Space Grotesk","Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 10% 20%, rgba(34, 211, 238, 0.08), transparent 25%), 
                  radial-gradient(circle at 80% 0%, rgba(14, 165, 233, 0.08), transparent 22%),
                  var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
      line-height: 1.6;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      color: var(--accent-hover);
      text-decoration: underline;
    }

    /* Header */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(17, 24, 39, 0.92);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
      transition: all 0.3s ease;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      gap: 20px;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-grow: 1;
    }

    .header-title {
      margin: 0;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.3px;
      color: var(--text);
    }

    .theme-toggle {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--border);
    }

    /* Main container */
    .main-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 18px 44px;
    }

    /* Hero section */
    .hero {
      margin-bottom: 36px;
      text-align: left;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.25);
    }

    .hero-headline {
      margin: 0 0 8px 0;
      font-size: 32px;
      font-weight: 800;
      line-height: 1.2;
      color: var(--text);
    }

    .hero-subtitle {
      margin: 0 0 12px 0;
      font-size: 17px;
      color: var(--muted);
      max-width: 720px;
    }

    .hero-tags {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 12px 0 0;
    }

    .tag {
      background: rgba(34, 211, 238, 0.12);
      color: var(--accent-hover);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid rgba(34, 211, 238, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.25);
    }

    /* Query card */
    .query-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 40px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .query-card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .query-card h2 {
      margin: 0 0 8px 0;
      font-size: 20px;
    }

    .query-description {
      color: var(--muted);
      margin: 0 0 20px 0;
      font-size: 15px;
    }

    #ask-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 16px;
      font-size: 15px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      resize: vertical;
      transition: all 0.2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea::placeholder {
      color: var(--muted);
    }

    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn {
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status {
      flex: 1;
      color: var(--muted);
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status.error {
      color: #ef4444;
    }

    .status.success {
      color: #10b981;
    }

    .status-icon {
      display: inline-block;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Results section */
    .results-section {
      margin-bottom: 40px;
    }

    .results-section h3 {
      font-size: 18px;
      margin: 0 0 12px 0;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .card:hover {
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .card h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .pill {
      background: linear-gradient(135deg, var(--accent), #60a5fa);
      color: white;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .code-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      overflow-x: auto;
      position: relative;
    }

    .code-copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .code-copy-btn:hover {
      background: var(--border);
    }

    pre {
      margin: 0;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
      padding-right: 60px;
    }

    .rows-content {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      min-height: 100px;
      overflow-x: auto;
    }

    .rows-content.muted {
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-style: italic;
    }

    .table-wrap {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .data-table th {
      background: var(--border);
      color: var(--text);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .data-table td {
      padding: 12px;
      border-top: 1px solid var(--border);
    }

    .data-table tbody tr:nth-child(odd) {
      background: var(--bg);
    }

    .data-table tbody tr:hover {
      background: var(--border);
    }

    /* Expandable sections */
    .expandable-section {
      margin-bottom: 40px;
    }

    .expandable-trigger {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 18px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      transition: all 0.2s ease;
      user-select: none;
    }

    .expandable-trigger:hover {
      background: var(--border);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .expandable-trigger.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .toggle-icon {
      font-size: 20px;
      transition: transform 0.2s ease;
    }

    .expandable-trigger.active .toggle-icon {
      transform: rotate(180deg);
    }

    .expandable-content {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .expandable-content.active {
      display: block;
    }

    .expandable-content h4 {
      margin: 0 0 12px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .expandable-content p {
      margin: 0 0 12px 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .expandable-content p:last-child {
      margin-bottom: 0;
    }

    .expandable-content ul {
      margin: 0 0 16px 0;
      padding-left: 20px;
    }

    .expandable-content li {
      margin: 8px 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .example-prompts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .prompt-btn {
      padding: 12px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text);
      transition: all 0.2s ease;
      text-align: left;
    }

    .prompt-btn:hover {
      border-color: var(--accent);
      background: var(--border);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.25s ease;
      backdrop-filter: blur(8px);
    }

    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }

    .modal-card {
      background: var(--surface);
      max-width: 700px;
      width: 100%;
      border-radius: 14px;
      box-shadow: 0 20px 50px rgba(34, 211, 238, 0.18), 0 16px 40px rgba(0, 0, 0, 0.25);
      padding: 30px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      animation: pulseGlow 2.2s ease-in-out infinite;
    }

    .modal-card h3 {
      margin: 0 0 14px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .modal-card p {
      margin: 0 0 14px 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .modal-card ul {
      margin: 0 0 16px 0;
      padding-left: 20px;
      color: var(--muted);
    }

    .modal-card li {
      margin: 8px 0;
      line-height: 1.6;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: var(--border);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--accent);
      color: white;
    }

    .modal-cta {
      display: inline-block;
      margin-top: 12px;
      padding: 14px 18px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: #0b1120;
      border: none;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 0 20px rgba(34,211,238,0.55);
      animation: pulseGlow 2.2s ease-in-out infinite;
      width: 100%;
      text-align: center;
    }

    @keyframes pulseGlow {
      0% { box-shadow: 0 0 16px rgba(34,211,238,0.35); transform: translateY(0); }
      50% { box-shadow: 0 0 28px rgba(34,211,238,0.65); transform: translateY(-2px); }
      100% { box-shadow: 0 0 16px rgba(34,211,238,0.35); transform: translateY(0); }
    }

    /* Utility classes */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    /* Loading animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        padding: 20px 16px;
      }

      .header-content {
        padding: 14px 16px;
      }

      .hero-headline {
        font-size: 32px;
      }

      .hero-subtitle {
        font-size: 16px;
      }

      .query-card {
        padding: 20px;
      }

      textarea {
        min-height: 120px;
      }

      .card {
        padding: 16px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .status {
        flex: none;
      }

      .modal-card {
        padding: 20px;
      }

      .data-table {
        font-size: 13px;
      }

      .data-table th, .data-table td {
        padding: 10px 8px;
      }
    }

    @media (max-width: 480px) {
      .header-title {
        font-size: 20px;
      }

      .hero-headline {
        font-size: 24px;
      }

      .hero-subtitle {
        font-size: 14px;
      }

      .hero-tags {
        gap: 8px;
      }

      .tag {
        padding: 6px 12px;
        font-size: 12px;
      }

      .query-description {
        font-size: 14px;
      }

      textarea {
        min-height: 100px;
        font-size: 16px; /* Prevent zoom on iOS */
      }

      .expandable-trigger {
        font-size: 14px;
        padding: 14px 16px;
      }

      .example-prompts {
        grid-template-columns: 1fr;
      }

      .prompt-btn {
        font-size: 12px;
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="header-content">
      <div class="header-brand">
        <h1 class="header-title">Cars AI</h1>
      </div>
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme" title="Toggle dark mode">ðŸŒ™</button>
    </div>
  </header>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Hero Section -->
    <section class="hero">
      <h2 class="hero-headline">Cars AI Playground</h2>
      <p class="hero-subtitle">Ask questions about cars in natural language, and let AI turn them into SQL queries. See results instantly.</p>
      <div class="hero-tags">
        <span class="tag">ðŸ¤– AI Agent</span>
        <span class="tag">ðŸ’¾ SQLite</span>
        <span class="tag">ðŸš€ Instant Results</span>
      </div>
    </section>

    <!-- Query Card -->
    <section class="query-card">
      <h2>Ask the Database</h2>
      <p class="query-description">Type a question about the cars table in natural language. The AI will translate it to SQL, validate it for safety, and fetch results from the database.</p>
      
      <form id="ask-form">
        <label for="question" class="sr-only">Your question</label>
        <textarea 
          id="question" 
          name="question" 
          placeholder="Example: Show me BMW cars under 80,000 km with automatic transmission and price under 25,000 EUR"
          required
        ></textarea>
        
        <div class="controls">
          <button type="submit" id="ask-btn" class="btn btn-primary">
            <span>Ask AI</span>
          </button>
          <div id="status" class="status" aria-live="polite">
            <span class="status-icon"></span>
            Ready for your question
          </div>
        </div>
      </form>
    </section>

    <!-- Results Section -->
    <section class="results-section">
      <div class="card" id="sql-card">
        <h3>Generated SQL</h3>
        <div class="code-block">
          <button type="button" class="code-copy-btn" id="copy-sql">Copy</button>
          <pre id="sql-output">(waiting)</pre>
        </div>
      </div>

      <div class="card" id="rows-card">
        <div class="card-header">
          <h3>Query Results</h3>
          <span id="row-count" class="pill">â€” rows</span>
        </div>
        <div id="rows-output" class="rows-content muted">Awaiting query.</div>
      </div>
    </section>

    <!-- How It Works Section -->
    <section class="expandable-section">
      <button type="button" class="expandable-trigger" id="how-it-works-trigger">
        <span>ðŸ“‹ How It Works</span>
        <span class="toggle-icon">â–¼</span>
      </button>
      <div class="expandable-content" id="how-it-works-content">
        <h4>The AI â†’ SQL â†’ DB Pipeline</h4>
        <p>This demo showcases a serverless workflow using LangChain + Groq:</p>
        <ul>
          <li><strong>Natural Language Understanding:</strong> Groq LLM interprets your question.</li>
          <li><strong>SQL Generation via LangChain:</strong> LangChain orchestrates a structured output from the LLM.</li>
          <li><strong>Safety Validation:</strong> Guardrails enforce SELECT/WITH-only SQL before execution.</li>
          <li><strong>Database Query:</strong> The validated SQL runs against the cars SQLite database.</li>
          <li><strong>Dynamic Results:</strong> Results are rendered as a clean, interactive HTML table.</li>
        </ul>
        <p><strong>Example questions you can ask:</strong></p>
        <ul>
          <li>"Show all BMW cars newer than 2018 under 80,000 km."</li>
          <li>"List the top 5 cheapest diesel cars."</li>
          <li>"Show automatic SUVs sorted by mileage ascending."</li>
          <li>"Show cars with no accident history and price under 10,000."</li>
        </ul>
      </div>
    </section>

    <!-- Example Prompts Section -->
    <section class="expandable-section">
      <button type="button" class="expandable-trigger" id="examples-trigger">
        <span>âœ¨ Example Prompts</span>
        <span class="toggle-icon">â–¼</span>
      </button>
      <div class="expandable-content" id="examples-content">
        <p>Click any example below to populate the query field:</p>
        <div class="example-prompts">
          <button type="button" class="prompt-btn" data-prompt="Show me all BMW cars with price under 30,000 EUR">
            BMW cars under 30k EUR
          </button>
          <button type="button" class="prompt-btn" data-prompt="Show the top 5 cheapest diesel cars with automatic transmission">
            Top 5 cheapest diesel automatics
          </button>
          <button type="button" class="prompt-btn" data-prompt="Show cars with no accident history sorted by price ascending">
            No accident history, cheapest first
          </button>
          <button type="button" class="prompt-btn" data-prompt="Show all electric cars with less than 50,000 km">
            Electric cars under 50k km
          </button>
          <button type="button" class="prompt-btn" data-prompt="Show luxury cars from 2020 onwards with automatic transmission">
            Luxury automatics from 2020+
          </button>
          <button type="button" class="prompt-btn" data-prompt="Show cars with accident history by brand">
            Cars with accident history
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal (How This Works) -->
  <div id="modal-overlay" class="modal-overlay" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal-close" type="button" aria-label="Close modal">&times;</button>
      <h3 id="modal-title">How this works (LangChain + Groq)</h3>
      <p>This Cars AI uses a LangChain-orchestrated pipeline with Groq to keep SQL generation safe and transparent.</p>
      <ul class="bullets">
        <li>Groq LLM interprets your plain-English question.</li>
        <li>LangChain requests structured output (SQL + safety flag + reason).</li>
        <li>Guardrails enforce SELECT/WITH-only, blocking DML/DDL before execution.</li>
        <li>A SQLite engine runs the validated SQL on the cars database.</li>
        <li>Results render instantly in the table below.</li>
      </ul>
      <button class="modal-cta" id="modal-cta-btn" type="button">Close and let me try it</button>
    </div>
  </div>

  <script>
    (function(){
      // Theme toggle
      const themeToggle = document.getElementById('theme-toggle');
      const html = document.documentElement;
      
      // Load theme preference from localStorage
      const savedTheme = localStorage.getItem('theme') || 'light';
      html.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
      
      function updateThemeIcon(theme) {
        themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
      }
      
      themeToggle.addEventListener('click', () => {
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
      });

      // Expandable sections
      const howItWorksTrigger = document.getElementById('how-it-works-trigger');
      const howItWorksContent = document.getElementById('how-it-works-content');
      const examplesTrigger = document.getElementById('examples-trigger');
      const examplesContent = document.getElementById('examples-content');

      function toggleSection(trigger, content) {
        trigger.classList.toggle('active');
        content.classList.toggle('active');
      }

      howItWorksTrigger.addEventListener('click', () => {
        toggleSection(howItWorksTrigger, howItWorksContent);
      });

      examplesTrigger.addEventListener('click', () => {
        toggleSection(examplesTrigger, examplesContent);
      });

      // Example prompts
      const promptButtons = document.querySelectorAll('.prompt-btn');
      const questionField = document.getElementById('question');

      promptButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const prompt = btn.getAttribute('data-prompt');
          questionField.value = prompt;
          questionField.focus();
        });
      });

      // Form and UI elements
      const form = document.getElementById('ask-form');
      const statusEl = document.getElementById('status');
      const sqlCard = document.getElementById('sql-card');
      const rowsCard = document.getElementById('rows-card');
      const sqlOutput = document.getElementById('sql-output');
      const rowsOutput = document.getElementById('rows-output');
      const rowCount = document.getElementById('row-count');
      const askBtn = document.getElementById('ask-btn');
      const copySqlBtn = document.getElementById('copy-sql');
      const modalOverlay = document.getElementById('modal-overlay');
      const modalClose = modalOverlay.querySelector('.modal-close');
      const modalCtaBtn = document.getElementById('modal-cta-btn');

      function setStatus(text, isError = false) {
        statusEl.innerHTML = `<span class="status-icon"></span>${text}`;
        statusEl.className = isError ? 'status error' : 'status';
      }

      function renderRows(rows) {
        let count = 0;
        rowsOutput.innerHTML = '';
        rowsOutput.className = 'rows-content';

        if (Array.isArray(rows)) {
          count = rows.length;
          rowCount.textContent = count === 1 ? '1 row' : `${count} rows`;
          if (!rows.length) {
            rowsOutput.textContent = 'No rows returned.';
            rowsOutput.classList.add('muted');
            return;
          }
          const keys = Object.keys(rows[0] || {});
          if (!keys.length) {
            rowsOutput.textContent = 'Rows returned but no columns to show.';
            rowsOutput.classList.add('muted');
            return;
          }
          const table = document.createElement('table');
          table.className = 'data-table';
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          rows.forEach(row => {
            const tr = document.createElement('tr');
            keys.forEach(k => {
              const td = document.createElement('td');
              const val = row && Object.prototype.hasOwnProperty.call(row, k) ? row[k] : '';
              td.textContent = val === null || typeof val === 'undefined' ? '' : val;
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          const wrap = document.createElement('div');
          wrap.className = 'table-wrap';
          wrap.appendChild(table);
          rowsOutput.appendChild(wrap);
          return;
        }

        if (rows && typeof rows === 'object') {
          const keys = Object.keys(rows);
          if (!keys.length) {
            rowCount.textContent = '0 rows';
            rowsOutput.textContent = 'No data returned.';
            rowsOutput.classList.add('muted');
            return;
          }
          count = 1;
          rowCount.textContent = '1 row';
          const table = document.createElement('table');
          table.className = 'data-table';
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          keys.forEach(k => {
            const th = document.createElement('th');
            th.textContent = k;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          const tr = document.createElement('tr');
          keys.forEach(k => {
            const td = document.createElement('td');
            const val = Object.prototype.hasOwnProperty.call(rows, k) ? rows[k] : '';
            td.textContent = val === null || typeof val === 'undefined' ? '' : val;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
          table.appendChild(tbody);
          const wrap = document.createElement('div');
          wrap.className = 'table-wrap';
          wrap.appendChild(table);
          rowsOutput.appendChild(wrap);
          return;
        }

        rowCount.textContent = '0 rows';
        rowsOutput.textContent = rows === null || typeof rows === 'undefined' ? 'No data returned.' : String(rows);
        rowsOutput.classList.add('muted');
      }

      function closeModal() {
        modalOverlay.classList.remove('show');
        modalOverlay.setAttribute('aria-hidden', 'true');
      }

      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (modalCtaBtn) modalCtaBtn.addEventListener('click', closeModal);
      if (modalOverlay) {
        modalOverlay.addEventListener('click', (e) => {
          if (e.target === modalOverlay) closeModal();
        });
        // Show modal on load
        setTimeout(() => {
          modalOverlay.classList.add('show');
          modalOverlay.setAttribute('aria-hidden', 'false');
        }, 200);
      }

      // Copy SQL button
      copySqlBtn.addEventListener('click', async () => {
        const sql = sqlOutput.textContent;
        if (sql && sql !== '(waiting)') {
          try {
            await navigator.clipboard.writeText(sql);
            copySqlBtn.textContent = 'Copied!';
            setTimeout(() => {
              copySqlBtn.textContent = 'Copy';
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const question = questionField.value.trim();
        if (!question) {
          setStatus('Please enter a question.', true);
          return;
        }

        askBtn.disabled = true;
        setStatus('Running query...');
        sqlCard.style.display = 'none';
        rowsCard.style.display = 'none';
        sqlOutput.textContent = '';
        rowCount.textContent = 'â€”';
        rowsOutput.innerHTML = '';
        rowsOutput.className = 'rows-content muted';
        rowsOutput.textContent = 'Processing...';

        try {
          const response = await fetch('/api/nl-query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
          });

          const text = await response.text();
          let data;
          try {
            data = text ? JSON.parse(text) : {};
          } catch (err) {
            data = null;
          }

          if (!response.ok) {
            const message = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${response.status}`;
            setStatus('Error: ' + message, true);
            if (data && data.sql) {
              sqlOutput.textContent = data.sql;
              sqlCard.style.display = 'block';
            }
            return;
          }

          const sql = data && data.sql ? data.sql : '';
          const rows = data && typeof data.rows !== 'undefined' ? data.rows : data;

          sqlOutput.textContent = sql || '(no SQL returned)';
          renderRows(rows);
          sqlCard.style.display = 'block';
          rowsCard.style.display = 'block';
          setStatus('âœ“ Query succeeded');
        } catch (err) {
          setStatus('Error: ' + (err && err.message ? err.message : String(err)), true);
        } finally {
          askBtn.disabled = false;
        }
      });
    })();
  </script>
</body>
</html>
